Title: 自前ドメインメールサーバをSendgridへ移行中
Date: 2020-07-05
Category: Tech
Tags: SendGrid, Zapier
Slug: sendgrid
Authors: s.hosoya

[メモ記事](https://blog.watarinohibi.tokyo/posts/2020/04/25/mailserver/#mailserver)  

上記に書いたような手順で、自前でEC2インスタンス + Postfix を使ってSMTPサーバを、もう5年ぐらい？運用してる。  
もともとやりはじめたきっかけは、社会人としてインフラエンジニアになりました！となってから、インフラ運用の知識をプライベートでも得るために、  
自分でドメインとって、なんらかサービス運用してみようの題材として独自ドメインのメールサーバを建てようと思ったのがきっかけ。  
気が付けば大抵のことはこのメールサーバでホストされるメールアドレスでやりくりするようになった一方で、EC2フリープランは1年間しか使えないので毎年引越ししてたり、  
使ってるドメインが .tokyo なこともあり お名前.com から googledomains へ移管できなかったりで、いろいろ不満がたまってきた。  

ここらでなんか新しいもの知ろうと思い、SendGrid を使ったサーバレスへ移行を計画。  
いろいろ調べてみたところ、まさになものを SendGrid 自身が紹介しており、試してみることにした。  

[メールを受信する](https://sendgrid.kke.co.jp/docs/Tutorials/E_Receive_Mail/receive_mail.html)  
[SendGridで受信したメールの内容をメールクライアントで確認する](https://sendgrid.kke.co.jp/blog/?p=9806)  

---

SendGrid は本来（？）、マーケティングやビジネスメールの一斉配信用のサービスだけど、受信もできる。  
MXレコードやらなんやらの設定がいるので、当然DNS周りの知識もいるけど別に難しくはない。  
今回はSendGridのアカウントを得るのにDNS認証（TXTレコード認証）を使い、新しくとったドメインのサブドメインで MX レコードを利用して、ドメインへ飛んできたメールを SendGrid で取得し、さらにそれを SendGrid から outgoing 方向の webhook で Zapier と連携し、Gmailへ飛ばすという手順で構築した。  
文字で書くとなんのこっちゃという感じだけど。。  

※構成図をかいてみよう  

ポイントは、  

* 宛先が独自ドメイン  
* Gmailへ転送したい（自分の Gmail クライアントで見たい）  
* 送信はできなくていい  

というところかな。  

SendGridフリープラン、Zapierもフリープラン（ただし月1000通（アクション）までかな？）が対応可能。  
上記の記事に従い設定は完了したけど、何点か気になる点。  

---

# Toを独自ドメインのメールアドレスのままにできない  

Zapier は SendGrid の Webhook を受けて、Gmail*から* メールを飛ばす → GmailからGmailへ飛ばすことになる  
この時、メールの To: を独自ドメインのメールアドレスにしたままだと、ここが無限ループに陥る...（実際陥った、あせった  

# SendGrid で受信したメールが文字化けする

ISO-2022-JP のメールは残念ながら文字化けしてしまう。。  
まだまだ国内には多く、メールアドレスの設定してからいくつかサービスで登録してるメールを切り替えてみたら気づいた。  

SendGrid に着弾した時点でもう文字化けてたので、Zapier でもどうすることもできないのか、そもそも文字化けさせないようになんとかできないのか調べる...

# HTMLメールとテキストメールの使い分け  

Zapier があまり柔軟にできなくて（できるのかもだけど）、メールのbodyがHTMLとPlainで完全に別物扱い。  
転送する際にどっちかを選べないので、仕方なく body にどっちも詰め込んでるけど、両方が届くと両方はいってしまう、、うーん、あまりイケてない。  
これも、どっちか入ってるほう or 両方はいってたら HTML のみ、とかにしたいんだけど、そこまで柔軟に制御するためにはなんらかコード書かないとかなぁ。  

---
とまぁ、まだちょっと問題はあるけど、コードレス＆サーバレスで独自ドメインのメールアドレスの受信環境は作れた。  
postfixのメンテナンス続けなくていいようにもうちょい頑張ってみる。  
